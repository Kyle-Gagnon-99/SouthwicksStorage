<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{template/navbar.html}">
<head>
    <title>Title</title>
</head>
<body>
    <main class="content" layout:fragment="mainSection">
        <div class="container-fluid">
            <div class="header">
                <h1 class="header-title">
                    View Users
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">View Users</li>
                    </ol>
                </nav>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">View Users</h5>
                            <h6 class="card-subtitle text-muted">View all users</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
	                            <table id="datatables-basic" class="table table-striped">
	                                <thead>
	                                    <tr>
	                                        <th>Vendor Name</th>
	                                        <th>Contact Name</th>
	                                        <th>Contact Phone Number</th>
	                                        <th>Additional Information</th>
	                                        <th>Actions</th>
	                                    </tr>
	                                </thead>
	                                <tbody>
	                                    <tr th:each="vendors : ${vendorList}">
	                                        <td><span th:text="${vendors.vendorName}" class="vendorNameClass">Vendor name</span></td>
	                                        <td><span th:text="${vendors.contactName}" class="contactNameClass">Contact name</span></td>
	                                        <td><span th:text="${vendors.contactPhoneNumber}" class="contactPhoneClass">Contact Phone number</span></td>
	                                        <td class="table-action">
	                                        	<a th:href="@{vendor/findById/(id=${vendors.id})}" class="btn viewAdditionalInfo"><i class="align-middle fas fa-fw fa-eye"></i></a>
	                                        </td>
	                                        <td class="table-action">
	                                            <a th:href="@{vendor/findById/(id=${vendors.id})}" class="btn editButton"><i class="align-middle fas fa-fw fa-pen"></i></a>
												<a th:href="@{vendor/findById/(id=${vendors.id})}" class="btn deleteButton"><i class="align-middle fas fa-fw fa-trash"></i></a>
	                                        </td>
	                                    </tr>
	                                </tbody>
                            	</table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="editVendor">
       		<div class="modal" id="editModal" tabindex="-1" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Edit Vendor</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<form id="validateForm">
							<div class="modal-body m-3">
								<div class="mb-3">
									<input type="hidden" id="editVendorId">
	                                <label for="vendorName">Vendor Name</label>
	                                <input type="text" class="form-control" id="editVendorName" name="vendorName" placeholder="Vendor">
	                            </div>
	                            <div class="mb-3">
	                                <label for="contactName">Contact Name</label>
	                                <input type="text" class="form-control" id="editContactName" name="contactName" placeholder="Contact Name">
	                            </div>
	                            <div class="mb-3">
	                                <label for="contactPhoneNumber">Contact Phone Number</label>
	                                <input type="text" class="form-control" id="editContactPhoneNumber" name="contactPhoneNumber" placeholder="Contact Phone Number" data-mask="(000) 000-0000">
	                            </div>
	                            <div class="mb-3">
	                               	<label for="additionalInfo">Additional Information</label>
	                                <textarea type="text" class="form-control" id="editAdditionalInfo" name="additionalInfo" placeholder="Additional Information"></textarea>
	                            </div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
								<button type="submit" class="btn btn-primary editVendorForm">Save changes</button>
							</div>
						</form>
					</div>
				</div>
			</div>
        </div>
        <div class="additionalInfoModal">
       		<div class="modal" id="additionalInfoModalSub" tabindex="-1" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">View Additional Information</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body m-3">
							<div class="mb-3 text-center">
								<p>Additional Information</p>
								<textarea id="additionalInfoTextArea" class="additionalInfoTextArea" style="min-width: 100%" readonly></textarea>
                            </div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
						</div>
					</div>
				</div>
			</div>
        </div>
        <div class="deleteVendor">
        	<form id="deleteVendorForm">
        		<div class="modal" id="deleteModal" tabindex="-1" role="dialog">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Delete Vendor</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body m-3">
								<div class="mb-3">
									<p>Are you sure you want to delete this vendor?</p>
									<p>WARNING: Deleting this vendor will remove the vendor from all products associated to this vendor</p>
									<p>The products will still be there but the vendor will be gone</p> 
									<input type="hidden" id="deleteVendorId">
	                            </div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
								<button type="submit" class="btn btn-danger" id="deleteVendorButton">Delete Vendor</button>
							</div>
						</div>
					</div>
				</div>
        	</form>
        </div>
    </main>

    <script layout:fragment="customJS">
		var editButton = '';
		var deleteButton = '';
		
		// Datatable
        document.addEventListener("DOMContentLoaded", function() {
			$('#datatables-basic').DataTable({
			});
		});

        $(document).ready(function() {
        	// Prevent submit
        	$('#validateForm').on('submit', function(event){
        		event.preventDefault();
        	});
        	
        	// Handle delete submit button function here since we are not using validation
        	$('#deleteVendorForm').on('submit', function(event){
        		event.preventDefault();
        		$.post('/view/vendor/deleteVendor', {id: $('.deleteVendor #deleteVendorId').val()}, function(e){
        			
        		});
        		deleteButton.parent().parent().remove();
        		$('.deleteVendor #deleteModal').modal('hide');
        	});
        	
        	// Validate the results of saving the changes to the vendor
        	$("#validateForm").validate({
        		rules: {
        			vendorName: {
        				required: true
        			},
        			contactName: {
        				required: true
        			},
        			additionalInfo: {
        				maxlength: 500
        			}
        		},
				messages: {
					vendorName: "Vendor Name is required",
					contactName: "Contact Name is required",
					additionalInfo: "Additional Information can not be more than 500 characters"
				},
        		// Errors
				errorPlacement: function errorPlacement(error, element) {
					error.addClass('jquery-validation-error small form-text invalid-feedback')
					element.parent().append(error);
				},
				highlight: function(element) {
					var $el = $(element);
					var $parent = $el.parents(".error-placeholder");
					$el.addClass("is-invalid");
				},
				unhighlight: function(element) {
					$(element).parents().find(".is-invalid").removeClass("is-invalid");
				},
				submitHandler: function(form) {
            		var vendorId = $('#editVendorId').val();
            		var vendorName = $('#editVendorName').val();
            		var contactName = $('#editContactName').val();
            		var contactPhoneNumber = $('#editContactPhoneNumber').val();
            		var additionalInfo = $('#editAdditionalInfo').val();
            		$.post('/view/vendor/editVendor', 
            				{id: vendorId, vendorName: vendorName, contactName: contactName, contactPhoneNumber: contactPhoneNumber, additionalInfo: additionalInfo}, 
            				function(returnedData){
            					//var button = $('#validateForm :submit');
            					editButton.parent().parent().children().find(".vendorNameClass").text(returnedData.vendorName);
            					editButton.parent().parent().children().find(".contactNameClass").text(returnedData.contactName);
            					editButton.parent().parent().children().find(".contactPhoneClass").text(returnedData.contactPhoneNumber);
            				});
            		$('.editVendor #editModal').modal('hide');
				}
        	});
        	
        	// Take care of populating fields to edit
        	$('.table .editButton').on('click', function(event) {
        		event.preventDefault();
        		var href = $(this).attr('href');
        		editButton = $(this);
        		$.get(href, function(vendor, status){
        			$('.editVendor #editVendorId').val(vendor.id);
        			$('.editVendor #editVendorName').val(vendor.vendorName);
        			$('.editVendor #editContactName').val(vendor.contactName);
        			$('.editVendor #editContactPhoneNumber').val(vendor.contactPhoneNumber);
        			$('.editVendor #editAdditionalInfo').val(vendor.additionalInfo);
        		});
        		
        		// Show edit modal
        		$('.editVendor #editModal').modal('show');
        		
        	});
        	
        	// Populate delete vendor modal
        	$('.table .deleteButton').on('click', function(event) {
        		event.preventDefault();
        		deleteButton = $(this);
        		var href = $(this).attr('href');
        		$.get(href, function(vendor, status){
        			$('.deleteVendor #deleteVendorId').val(vendor.id);
        		});
        		
        		$('.deleteVendor #deleteModal').modal('show');
        	});
        	
        	$('.table .viewAdditionalInfo').on('click', function(event) {
        		event.preventDefault();
        		var href = $(this).attr('href');
        		$.get(href, function(vendor, status) {
        			$('.additionalInfoModal #additionalInfoTextArea').val(vendor.additionalInfo);
        		});
        		
        		$('.additionalInfoModal #additionalInfoModalSub').modal('show');
        	});
        	
        });

    </script>
</body>
</html>